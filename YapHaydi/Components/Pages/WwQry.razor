@inject IDataAccess db
@inject IDbCon dbCon
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@page "/wq"

@if(wqp != null)
{
	<table class="bg-slate-200 m-auto"> 
		<tr>
			<td class="border border-slate-300 px-1 text-red-700">Tarih aralığı</td>
			<td class="border border-slate-300">
				<select id="rngFld" name="rngFld" @bind="qry.rngFld" class="w-24 px-1">
					@foreach(var r in rf)
					{
						<option value="@r.OptVal">@r.OptTxt</option>
					}
				</select>
			</td>
			<td class="border border-slate-300 text-center">
				<input type="date" @bind="qry.rngGE" placeholder="Başlangıç tarih >=" />
			</td>
			<td class="border border-slate-300 text-center">
				<input type="date" @bind="qry.rngLT" placeholder="Bitiş tarih <" />
			</td>
		</tr>
		<tr>
			<td class="border border-slate-300 px-1 text-red-700">Filtre</td>
			<td class="border border-slate-300">
				<select id="fltFld" name="fltFld" @bind="qry.fltFld" class="w-24 px-1">
					@foreach(var r in ff)
					{
						<option value="@r.OptVal">@r.OptTxt</option>
					}
				</select>
			</td>
			<td class="border border-slate-300">
				<select id="cars" name="cars" @bind="qry.fltCnd" class="w-24 px-1">
					@foreach(var r in fc)
					{
						<option value="@r.OptVal">@r.OptTxt</option>
					}
				</select>
			</td>
			<td class="border border-slate-300">
				<input type="search" class="w-24 px-1" @bind="qry.fltVal" @bind:event="oninput" placeholder="..." />
			</td>
		</tr>
		<tr>
			<td class="border border-slate-300 px-1 text-red-700">Order</td>
			<td class="border border-slate-300">
				<select id="ordFld" name="ordFld" @bind="qry.ordFld" class="w-24 px-1">
					@foreach(var r in of)
					{
						<option value="@r.OptVal">@r.OptTxt</option>
					}
				</select>
			</td>
			<td class="border border-slate-300">
				<select id="ordVal" name="ordVal" @bind="qry.ordVal" class="w-24 px-1">
					@foreach(var r in oc)
					{
						<option value="@r.OptVal">@r.OptTxt</option>
					}
				</select>
			</td>
			<td class="text-center">
				<button type="button" @onclick="QryArgsSelected">🔎 ARA</button>
			</td>
		</tr>
	</table>
}

@code {
	[Parameter]
	public WwQryArgs qry { get; set; } = new();

	[Parameter]
	public EventCallback<WwQryArgs> OnQryArgsSelected { get; set; }

	public IEnumerable<WQP> wqp;
	public List<WQP> rf = new();
	public List<WQP> ff = new();
	public List<WQP> fc = new();
	public List<WQP> of = new();
	public List<WQP> oc = new();

	public void QryArgsSelected()
	{
		OnQryArgsSelected.InvokeAsync(qry);
	}

	protected override void OnInitialized()
	{
		// using IDbConnection conn = dbCon.GetConnection();
		// wqp = conn.Query<WQP>("select * from WQP");
		// wqp = db.LoadData<WQP, dynamic>("select * from WQP", new { });
		
		using (IDbConnection conn = dbCon.GetConnection())
		{
			wqp = conn.Query<WQP>("select * from WQP");
		}

		foreach(var p in wqp)
		{
			if(p.Typ == "RF")
				rf.Add(p);
			else if (p.Typ == "FF")
				ff.Add(p);
			else if (p.Typ == "FC")
				fc.Add(p);
			else if (p.Typ == "OF")
				of.Add(p);
			else if (p.Typ == "OC")
				oc.Add(p);
		}

	}

	public sealed class WQP 
	{
		public string Typ;
		public string OptTxt;
		public string OptVal;

	}
}
