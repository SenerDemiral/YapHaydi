@rendermode @(new InteractiveServerRenderMode(prerender: false))
@page "/inp"

<h2>rclv @rLCV.usrName</h2>

<div style="display:flex;justify-content:space-between;">
    <button disabled="@RO"
            @onclick="Cancel">
        🚫Vazgeç
    </button>
    <button disabled="@RO"
            @onclick="Save">
        ✅Kaydet
    </button>
</div>

@if(ww is not null) {
    <table class="table-edit">
        <tbody>
        <tr>
            <td>Id</td>
            <td>@ww.WWID</td>
        </tr>
        <tr>
            <td>Konu</td>
            <td>
                <input type="text" 
                       maxlength="30"
                       size="30"
                       list="TTSL"
                       @bind="ww.Sbj"
                       @bind:event="onchange"
                       @bind:after="(() => CheckTTS(ref ww.SbjID, ref ww.Sbj, oww!.Sbj))" />
             </td>
        </tr>
        <tr>
            <td colspan="2" style="background-color:gray;color:antiquewhite;text-align:center">Request</td>
        </tr>
        <tr>
            <td>Kim</td>
            <td>
                <input type="text" 
                       maxlength="30"
                       size="30"
                       list="TTXL"
                       @bind="ww.rWho"
                       @bind:event="onchange"
                       @bind:after="(() => CheckTTX(ref ww.rWhoID, ref ww.rWho, oww!.rWho))" />
             </td>
        </tr>
        <tr>
            <td>Info</td>
            <td>
                <textarea readonly="@RO"
                          rows="4" cols="30"
                          @bind="ww.rInf" 
                          style="resize:vertical;height:42px" />
            </td>
        </tr>
        <tr>
            <td colspan="2" style="background-color:gray;color:antiquewhite;text-align:center">Yapan</td>
        </tr>
        <tr>
            <td>Dept</td>
            <td>
                <input type="text" 
                       maxlength="30"
                       size="30"
                       list="TTDL"
                       @bind="ww.mDpt"
                       @bind:event="onchange"
                       @bind:after="(() => CheckTTD(ref ww.mDptID, ref ww.mDpt, oww!.mDpt))" />
             </td>
        </tr>
        <tr>
            <td>Kişi</td>
            <td>
                <input type="text" 
                       maxlength="30"
                       size="30"
                       list="TTXL"
                       @bind="ww.mWho"
                       @bind:event="onchange"
                       @bind:after="(() => CheckTTX(ref ww.mWhoID, ref ww.mWho, oww!.mWho))" />
             </td>
        </tr>
        <tr>
            <td colspan="2" style="background-color:gray;color:antiquewhite;text-align:center">Başlangıç</td>
        </tr>
        <tr>
            <td>Contact</td>
            <td>
                <input type="text" 
                       maxlength="30"
                       size="30"
                       list="TTXL"
                       @bind="ww.sCnt"
                       @bind:event="onchange"
                       @bind:after="(() => CheckTTX(ref ww.sCntID, ref ww.sCnt, oww!.sCnt))" />
             </td>
        </tr>
        <tr>
            <td>Adres</td>
            <td>
                <input type="text" 
                       maxlength="30"
                       size="30"
                       list="TTXL"
                       @bind="ww.sAdr"
                       @bind:event="onchange"
                       @bind:after="(() => CheckTTX(ref ww.sAdrID, ref ww.sAdr, oww!.sAdr))" />
             </td>
        </tr>
        <tr>
            <td></td>
            <td>@ww.sAdres</td>
        </tr>
        <tr>
            <td>Tahmini</td>
            <td><input readonly="@RO" type="date" @bind="ww.SED" />
                <input readonly="@RO" type="time" @bind="ww.SEDt" />
            </td>
        </tr>
        <tr>
            <td>Gerçek</td>
            <td>@ww.SADs</td>
        </tr>
        <tr>
            <td>Info</td>
            <td>
                <textarea readonly="@RO"
                          rows="4" cols="30"
                          @bind="ww.sInf" 
                          style="resize:vertical;height:42px" />
            </td>
        </tr>
        <tr>
            <td colspan="2" style="background-color:gray;color:antiquewhite;text-align:center">Bitiş</td>
        </tr>
        <tr>
            <td>Contact</td>
            <td>
                <input type="text" 
                       maxlength="30"
                       size="30"
                       list="TTXL"
                       @bind="ww.fCnt"
                       @bind:event="onchange"
                       @bind:after="(() => CheckTTX(ref ww.fCntID, ref ww.fCnt, oww!.fCnt))" />
             </td>
        </tr>
        <tr>
            <td>Adres</td>
            <td>
                <input type="text" 
                       maxlength="30"
                       size="30"
                       list="TTXL"
                       @bind="ww.fAdr"
                       @bind:event="onchange"
                       @bind:after="(() => CheckTTX(ref ww.fAdrID, ref ww.fAdr, oww!.fAdr))" />
             </td>
        </tr>
        <tr>
            <td></td>
            <td style="width:200px">@ww.fAdres</td>
        </tr>
        <tr>
            <td>Tahmini</td>
            <td><input readonly="@RO" type="date" @bind="ww.FED" />
                <input readonly="@RO" type="time" @bind="ww.FEDt" />
            </td>
        </tr>
        <tr>
            <td>Gerçek</td>
            <td>@ww.FADs</td>
        </tr>
        <tr>
            <td>Info</td>
            <td>
                <textarea readonly="@RO"
                          rows="4" cols="30"
                          @bind="ww.fInf" 
                          style="resize:vertical;height:42px" />
            </td>
        </tr>
        <tr>
            <td colspan="2" style="background-color:gray;color:antiquewhite;text-align:center">Destinasyon</td>
        </tr>
        <tr>
            <td>Contact</td>
            <td>
                <input type="text" 
                       maxlength="30"
                       size="30"
                       list="TTXL"
                       @bind="ww.sCnt"
                       @bind:event="onchange"
                       @bind:after="(() => CheckTTX(ref ww.sCntID, ref ww.sCnt, oww!.sCnt))" />
             </td>
        </tr>
        <tr>
            <td>Adres</td>
            <td>
                <input type="text" 
                       maxlength="30"
                       size="30"
                       list="TTXL"
                       @bind="ww.dAdr"
                       @bind:event="onchange"
                       @bind:after="(() => CheckTTX(ref ww.dAdrID, ref ww.dAdr, oww!.dAdr))" />
             </td>
        </tr>
        </tbody>
    </table>


    <datalist id="TTXL">
        @foreach (var r in ttx!)
        {
            <option value="@r.Key" />
        }
    </datalist>

    <datalist id="TTSL">
        @foreach (var r in tts!)
        {
            <option value="@r.Key" />
        }
    </datalist>

    <datalist id="TTDL">
        @foreach (var r in ttd!)
        {
            <option value="@r.Key" />
        }
    </datalist>
}

@code {
    [Inject] NavigationManager Navigation { get; set; } 
    [Inject] IDataAccess db { get; set; }
    [CascadingParameter] 
    public RLCV rLCV { get; set; }
    [Inject] 
    CascadingValueSource<RLCV>? RLCVsource { get; set; } = default;
    [Parameter] 
    public int ID { get; set; }
    [Parameter] 
    public EventCallback OnSaved { get; set; }
    [Parameter] 
    public EventCallback OnCancelled { get; set; }

    private WWmodel? ww, oww;
    private bool RO = false;
    private int FFID = 101;
    private Dictionary<string, int>? ttx, tts, ttd;

    private string Pge = "Inp";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Console.WriteLine($"{Pge}.OARA s {firstRender.ToString()} {rLCV.usrName}");
            //await Task.Delay(10);
            //Console.WriteLine($"{Pge}.OARA s {firstRender.ToString()} after delay 1");
            //await Task.Delay(10);
            //Console.WriteLine($"{Pge}.OARA f {firstRender.ToString()} after delay 2");
        }
    }

    protected override void OnParametersSet()
    {
        // Console.WriteLine($"{Pge}.OPS s");
        // base.OnParametersSet();
        // Console.WriteLine($"{Pge}.OPS f");
    }

    // protected override async Task OnParametersSetAsync()
    // {
    //     Console.WriteLine($"{Pge}.OPSA s");
    //     //await Task.Delay(10);
    //     Console.WriteLine($"{Pge}.OPSA f");
    // }

    private void CheckTTX(ref int? id, ref string? adx, string? oadx)
    {
        if (ttx!.TryGetValue(adx!, out var nid))
        {
            id = nid;
        }
        else
        {
            adx = oadx;
        }
    }

    private void CheckTTS(ref int? id, ref string? adx, string? oadx)
    {
        if (tts!.TryGetValue(adx!, out var nid))
        {
            id = nid;
        }
        else
        {
            adx = oadx;
        }
    }

    private void CheckTTD(ref int? id, ref string? adx, string? oadx)
    {
        if (ttd!.TryGetValue(adx!, out var nid))
        {
            id = nid;
        }
        else
        {
            adx = oadx;
        }
    }

    private void Cancel()
    {
        rLCV.usrName = "Dilara";
        RLCVsource?.NotifyChangedAsync();

        // zaten buradan geri dönecek, ilk değerlerini geri almaya gerek yok. ww = oww Bu çalışmaz birbirine eşitliyor copy yapmıyor;
        // ww = oww.ShallowCopy(); //Gerekirse bu OK 
        // OnCancelled.InvokeAsync();
    }
    private void Save()
    {
        var ppm = new   // Sirasi onemli Procedure Input sirasiyla ayni olmali
        {
            aaa = "aaa"
        };

        db.SaveRec("WW_MDF", ppm);
        OnSaved.InvokeAsync();
    }

    protected override async Task OnInitializedAsync()
    {
        // Console.WriteLine($"{Pge}.OIA s {rLCV.usrName}");
        // await Task.Delay(100);
        // Console.WriteLine($"{Pge}.OIA after delay 1 {rLCV.usrName}");
        
        // Console.WriteLine($"{Pge}.{rLCV.usrName}");

       
        
        //rLCV.usrName = "DENEME";

        // await Task.Delay(10);
        // Console.WriteLine($"{Pge}.OIA after delay 2");
        //  await Task.Delay(10);
        //  Console.WriteLine($"{Pge}.OIA after delay 3");
        //  await Task.Delay(1);
        //  Console.WriteLine($"{Pge}.OIA after delay 4");
        Console.WriteLine($"{Pge}.OIA f");
        
        var tt = db.LoadData<TT, dynamic>("select * from TT_LU(@FFID)", new { FFId = FFID });
        ttx = new();
        tts = new();
        ttd = new();
        foreach(var r in tt)
        {
            if(r.Typ == "X")
            {
                ttx.Add(r.AdX, r.TTId);
            }
            else if(r.Typ == "S")
            {
                tts.Add(r.AdX, r.TTId);
            }
            if(r.Typ == "D")
            {
                ttd.Add(r.AdX, r.TTId);
            }
        }

        //ttx = db.LoadData<TT, dynamic>("select * from TT_LU(@FFID) where Typ='X'", new { FFId = FFID }).ToDictionary((k) => k.AdX);

        //if (ScpC.IsAdm || ScpC.IsTnm)
        ww = db.LoadRec<WWmodel, dynamic>("select * from WW_SEL(@WWId,@FFId,@UsrId)", new { WWId=ID, FFId=FFID, UsrId=1 });
        // else
        // Navigation.NavigateTo("login");
        //pp = db.LoadRec<PP, dynamic>("select * from PP where PPId = @PPId", new { PPId = PPId });
        oww = ww.ShallowCopy();
    }

    private sealed class TT
    {
        public int TTId { get; set; }
        public string Typ { get; set; }
        public string AdX { get; set; }
    }

}
